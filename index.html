<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tap&amp;Say Text Editor</title>

  <style>
    /*******************************************************
     * 0) È°µÈù¢Â∏ÉÂ±ÄÔºöÈ°µËÑöË¥¥Â∫ï + Ê∏êÂèòËÉåÊôØ + PCÁ´ØÊõ¥Â§ßÊ∞î
     *******************************************************/
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      box-sizing: border-box;
      overflow-x: hidden;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* ‰øùËØÅÈ°µÈù¢Ëá≥Â∞ë‰∏éËßÜÁ™óÁ≠âÈ´ò */
    }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem 0; /* PCÁ´ØÊó∂‰øùÁïôÈ¢ùÂ§ñÁ©∫ÁôΩ */
    }
    #header-container, #footer-container {
      width: 100%;
      margin: 0;
      padding: 0;
      flex-shrink: 0;
    }
    .container {
      width: 90%;
      max-width: 900px; /* PCÁ´ØÁ®çÂæÆÊõ¥ÂÆΩ */
      margin: 0 auto;
      box-sizing: border-box;
    }

    /*******************************************************
     * 1) Ê®°ÂºèÊåâÈíÆÂÆπÂô® #mode-buttons => Â§ßÊåâÈíÆ + ÂúÜËßí
     *******************************************************/
    #mode-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0;
      gap: 20px; /* ËÆ©ÊåâÈíÆ‰πãÈó¥ÁïôÁ©∫ */
    }
    .mode-button {
      flex: 1;
      padding: 1rem 1.2rem;
      border: none;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      cursor: pointer;
      font-size: 1.1rem;
      color: #4a5568;
      text-align: center;
      transition: all 0.3s ease;
    }
    .mode-button.active {
      background: #4299e1;
      color: #fff;
    }
    .mode-button:hover:not(.active) {
      background: #f7fafc;
      transform: translateY(-1px);
    }

    /*******************************************************
     * 2) Âç°Áâá .card => ÂúÜËßí + Èò¥ÂΩ±
     *******************************************************/
    .card {
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      box-sizing: border-box;
    }

    /*******************************************************
     * 3) #text-editor => Â§ßÊ∞îÊÑü + ÂúÜËßí + Èò¥ÂΩ±
     *******************************************************/
    #text-editor {
      width: 100%;
      min-height: 200px;
      box-sizing: border-box;
      resize: vertical;      
      overflow: auto;        
      margin: 0 auto;
      background: #fff;      
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.5rem;
      font-size: 1.1rem;
      line-height: 1.6;
      color: #2d3748;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #text-editor:focus {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
    }
    #text-editor, 
    #text-editor * {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }

    /*******************************************************
     * 4) È´ò‰∫ÆÈ¢úËâ≤ => ÊüîÂíåÈªÑ
     *******************************************************/
    .highlighted-sentence {
      background-color: #fff3cd; 
      transition: background 0.3s;
    }

    /*******************************************************
     * 5) ÁõëÊéß / Êó•Âøó => ÂúÜËßí + ÁÆÄÊ¥Å
     *******************************************************/
    #mic-status {
      font-weight: bold;
      color: red;
    }
    #event-log {
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /*******************************************************
     * 6) ÊÇ¨ÊµÆÂª∫ËÆÆÊ°Ü => Áé∞‰ª£È£éÊ†º
     *******************************************************/
    .suggestions-box-floating {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 5px;
      z-index: 2000;
      user-select: none;
      pointer-events: auto;
      max-height: 150px;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    .suggestions-box-floating div {
      padding: 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.3s;
    }
    .suggestions-box-floating div:hover {
      background: #f0f0f0;
    }

    /*******************************************************
     * 7) Toast => fixed Â∫ïÈÉ®ÊèêÁ§∫
     *******************************************************/
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 12px 24px;
      border-radius: 5px;
      z-index: 3000;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    /*******************************************************
     * 8) Drawer => Â∑¶‰∏ãËßíÊäΩÂ±â + ÂúÜËßí
     *******************************************************/
    #drawer {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 3000;
      background: #007bff; 
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .drawer-collapsed {
      transform: translateX(-220px);
      opacity: 0.9;
    }
    #drawer-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      color: #fff;
      background: #0056b3;
      cursor: pointer;
      padding: 8px 10px;
      transition: background 0.3s;
      margin-bottom: 5px;
    }
    #drawer-toggle:hover {
      background: #003e80;
    }
    #drawer button:not(#drawer-toggle) {
      padding: 10px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      color: #007bff;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      width: 100%;
    }
    #drawer button:not(#drawer-toggle):hover {
      background: #e9f1ff;
      color: #0056b3;
    }

    /*******************************************************
     * 9) ÊèêÁ§∫Âç°Áâá => Â∑¶‰æßÂΩ©Êù° + ÂúÜËßí
     *******************************************************/
    .tip-box {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 4px;
      font-size: 14px;
      color: #495057;
    }
    .tip-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tip-content i {
      color: #ffc107;
    }

    /*******************************************************
     * 10) ÁÆ≠Â§¥ÊåâÈíÆ => nav-button
     *******************************************************/
    .nav-button {
      background: #4299e1;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .nav-button:hover {
      background: #307acc;
    }

    /*******************************************************
     * ÂìçÂ∫îÂºè => Â∞èÂ±èÁ´ñÊéí
     *******************************************************/
    @media (max-width:480px){
      .card {
        padding:16px;
      }
      #mode-buttons {
        flex-direction:column;
      }
      #mode-buttons .mode-button {
        width:100%;
        margin-bottom:8px;
      }
    }
  </style>
</head>
<body>
  <!-- headerÂä†ËΩΩ -->
  <header id="header-container"></header>

  <!-- ‰∏ªÂÜÖÂÆπÔºöÊíëÂºÄÔºåËÆ©footerË¥¥Â∫ï -->
  <div class="main-content">
    <div class="container">
      <!-- Ê®°ÂºèÂàáÊç¢ÊåâÈíÆ -->
      <div id="mode-buttons">
        <button id="mode-experience" class="mode-button active">Introduction mode</button>
        <button id="mode-input" class="mode-button">Free-input mode</button>
      </div>
    </div>

    <!-- Drawer Container -->
    <div id="drawer" class="drawer-collapsed">
      <button id="drawer-toggle">
        <span style="flex:1;"></span><span>&lt;</span>
      </button>
      <button id="toggle-monitoring">Show Monitoring</button>
      <button id="toggle-log">Show Event Log</button>
      <button id="toggle-ime">Disable IME Shortcuts: OFF</button>
    </div>

    <div class="container">
      <!-- ÁõëÊéßÂå∫Âüü -->
      <div class="card" id="monitoring-card">
        <p><strong>Error Sentence:</strong> <span id="error-text">None</span></p>
        <p><strong>Touch Index (relative):</strong> <span id="touch-index">None</span></p>
        <p><strong>Final Output:</strong> <span id="final-output">None</span></p>
        <p><strong>Recording Status:</strong> <span id="mic-status">üî¥ Stopped</span></p>
        <p style="display:none;"><strong>Original Error Sentence:</strong> <span id="original-error-sentence">None</span></p>
        <p style="display:none;"><strong>Speech Input:</strong> <span id="voice-input">None</span></p>
      </div>

      <!-- Ëá™Áî±ËæìÂÖ•Ê®°Âºè -->
      <div class="card" id="input-mode" style="display:none;">
        <h3>Tap&amp;Say Text Editor</h3>
        <div id="text-editor" contenteditable="true"></div>
        <button id="undo-button" style="
          margin-top:12px;
          width:100%;
          padding:14px;
          font-size:16px;
          border:none;
          border-radius:6px;
          background:#28a745;
          color:#fff;
          box-shadow:0 2px 6px rgba(0,0,0,0.2);
          cursor:pointer;
        ">Undo Last Change</button>
      </div>

      <!-- ‰ΩìÈ™åÊ®°Âºè -->
      <div class="card" id="experience-mode">
        <h3>Introduction Mode</h3>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <button class="nav-button" id="prev-sentence" style="visibility:hidden;">‚Üê</button>
            <span id="sentence-index">1/5</span>
            <button class="nav-button" id="next-sentence">‚Üí</button>
          </div>
          <p><strong>Target Sentence:</strong> <span id="target-sentence" style="user-select:none;"></span></p>
          <p><strong>Error Sentence:</strong> <span id="error-sentence" style="cursor:pointer;"></span></p>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button id="experience-undo-button" style="
              flex:1;
              padding:14px;
              font-size:16px;
              border:none;
              border-radius:6px;
              background:#28a745;
              color:#fff;
              box-shadow:0 2px 6px rgba(0,0,0,0.2);
              cursor:pointer;
            ">Restore Error Sentence</button>
            <button id="skip-sentence-button" style="
              flex:1;
              padding:14px;
              font-size:16px;
              border:none;
              border-radius:6px;
              background:#6c757d;
              color:#fff;
              box-shadow:0 2px 6px rgba(0,0,0,0.2);
              cursor:pointer;
            ">Follow the instruction</button>
          </div>
          <button id="next-pair-button" style="
            width:100%;
            margin-top:10px;
            padding:14px;
            font-size:16px;
            border:none;
            border-radius:6px;
            background:#007bff;
            color:#fff;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            cursor:pointer;
            display:none;
          ">Next Sentence</button>
        </div>
      </div>

      <!-- ‰∫ã‰ª∂Êó•ÂøóÂå∫Âüü -->
      <div class="card" id="event-log-card">
        <h3>Event Log</h3>
        <div id="event-log">No events recorded</div>
      </div>
    </div>
  </div>

  <!-- footerÂä†ËΩΩ -->
  <footer id="footer-container"></footer>

  <!-- ‰∏ãÈù¢‰øùÁïô‚ÄúÊàëÁöÑ‰ª£Á†Å‚ÄùÊâÄÊúâJSÈÄªËæë‰∏éÁªìÊûÑÔºå‰∏çÊîπ‰ªª‰ΩïÂáΩÊï∞/ID -->
  <script>
    /*******************************************************
     * 1) ÂÖ®Â±ÄÂ∏∏Èáè
     *******************************************************/
    const API_URL = "https://tns.zacchen.win/correct";  
    const PUNCTUATION_API_URL = "https://tns.zacchen.win/restore_punctuation";

    /*******************************************************
     * 2) Drawer ÂàáÊç¢
     *******************************************************/
    let drawerOpen=false;
    const drawer=document.getElementById("drawer");
    const drawerToggle=document.getElementById("drawer-toggle");
    drawerToggle.addEventListener("click",()=>{
      drawerOpen=!drawerOpen;
      if(drawerOpen){
        drawer.classList.remove("drawer-collapsed");
        drawerToggle.innerHTML='<span style="flex:1;"></span><span>&gt;</span>';
      } else {
        drawer.classList.add("drawer-collapsed");
        drawerToggle.innerHTML='<span style="flex:1;"></span><span>&lt;</span>';
      }
    });

    /*******************************************************
     * 3) ÂÖ®Â±ÄÂèòÈáè
     *******************************************************/
    let disableIME=false;
    let isListening=false;
    let pressTimer=null;
    let tapTriggered=false;
    let recognition=null;
    let silenceTimer=null;

    let globalTapIndex=-1;
    let localTapIndex=-1;
    let originalSentence="";
    let lastHighlightedSentence="";
    let highlightTimeout=null;
    let suggestionsBox=null;
    let suggestionsTimer=null;
    let undoStack=[];
    let currentMode=null;

    /* ‰ΩìÈ™åÊ®°Âºèindex */
    let currentPairIndex=0;
    const sentencePairs=[
      {
        target:"Your best bet is to drop him and go after another player.",
        error:"Your best bet is to drop him and go after another.",
        tip:"Tap near the mistake to highlight, then speak correction"
      },
      {
        target:"The team needs to focus on developing young talents.",
        error:"The team needs to focus on develop young talents.",
        tip:"Great! Try again"
      },
      {
        target:"She has been living in Paris for the past five years.",
        error:"She has lived in Paris since five years.",
        tip:"Multiple mistakes can be corrected multiple times"
      },
      {
        target:"The cat sat on the mat. The dog chased the cat. The mouse ran away quickly.",
        error:"The cat sat on the mat. The dog chase the cat. The mouse ran away quickly.",
        tip:"This also works for multi-sentence paragraphs"
      },
      {
        target:"They were discussing the implications of the new policy.",
        error:"They were discuss about the implications of the new policy.",
        tip:"If the first suggestion isn't correct, pick another from the list"
      }
    ];

    /*******************************************************
     * 4) DOM references
     *******************************************************/
    const monitoringCard=document.getElementById("monitoring-card");
    const eventLogCard=document.getElementById("event-log-card");
    const editor=document.getElementById("text-editor");
    const errorText=document.getElementById("error-text");
    const originalErrorSpan=document.getElementById("original-error-sentence");
    const touchIndexSpan=document.getElementById("touch-index");
    const voiceInputSpan=document.getElementById("voice-input");
    const micStatusSpan=document.getElementById("mic-status");
    const finalOutputSpan=document.getElementById("final-output");
    const eventLog=document.getElementById("event-log");

    const undoButton=document.getElementById("undo-button");
    const monitoringBtn=document.getElementById("toggle-monitoring");
    const eventLogBtn=document.getElementById("toggle-log");
    const imeBtn=document.getElementById("toggle-ime");

    const modeInput=document.getElementById("mode-input");
    const modeExperience=document.getElementById("mode-experience");
    const inputMode=document.getElementById("input-mode");
    const experienceMode=document.getElementById("experience-mode");

    /*******************************************************
     * 5) onload
     *******************************************************/
    window.onload=function(){
      loadHeaderFooter();
      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        navigator.mediaDevices.getUserMedia({audio:true})
        .catch(err=>{
          showToast("Please allow microphone access to use Tap&Say.");
          console.warn("Mic permission error:",err);
        });
      }
      initializeExperienceMode();

      // ÈªòËÆ§Â±ïÁ§∫‰ΩìÈ™åÊ®°Âºè
      inputMode.style.display="none";
      experienceMode.style.display="block";
      modeExperience.classList.add("active");
      modeInput.classList.remove("active");
    };
    async function loadHeaderFooter(){
      try{
        const headerRes=await fetch("header.html");
        const headerHtml=await headerRes.text();
        document.getElementById("header-container").innerHTML=headerHtml;

        const footerRes=await fetch("footer.html");
        const footerHtml=await footerRes.text();
        document.getElementById("footer-container").innerHTML=footerHtml;
      } catch(e){
        console.warn("Failed to load header/footer:",e);
      }
    }

    /*******************************************************
     * 6) ÁõëÊéß / Êó•Âøó / IME
     *******************************************************/
    monitoringBtn.addEventListener("click",()=>{
      monitoringCard.style.display=(monitoringCard.style.display==="none")?"block":"none";
      monitoringBtn.innerText=(monitoringCard.style.display==="none")?"Show Monitoring":"Hide Monitoring";
    });
    eventLogBtn.addEventListener("click",()=>{
      eventLogCard.style.display=(eventLogCard.style.display==="none")?"block":"none";
      eventLogBtn.innerText=(eventLogCard.style.display==="none")?"Show Event Log":"Hide Event Log";
    });
    imeBtn.addEventListener("click",()=>{
      disableIME=!disableIME;
      imeBtn.innerText=disableIME?"Disable IME Shortcuts: ON":"Disable IME Shortcuts: OFF";
      editor.style.webkitTouchCallout=disableIME?"none":"default";
    });

    /*******************************************************
     * 7) Toast & logEvent
     *******************************************************/
    function showToast(msg){
      const t=document.createElement("div");
      t.className="toast";
      t.innerText=msg;
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity=1; });
      setTimeout(()=>{
        t.style.opacity=0;
        setTimeout(()=>{ t.remove();},500);
      },2000);
    }
    function logEvent(message){
      const p=document.createElement("p");
      const now=new Date().toLocaleString("en-US",{hour12:false});
      p.innerText=`[${now}] ${message}`;
      eventLog.appendChild(p);
    }

    /*******************************************************
     * 8) File Drag & Drop
     *******************************************************/
    ["dragenter","dragover","dragleave","drop"].forEach(evtName=>{
      editor.addEventListener(evtName,e=>{
        e.preventDefault();
        e.stopPropagation();
      },false);
    });
    editor.addEventListener("dragover",()=>{ editor.style.background="#fafafa";});
    editor.addEventListener("dragleave",()=>{ editor.style.background="white";});
    editor.addEventListener("drop",e=>{
      editor.style.background="white";
      const files=e.dataTransfer.files;
      if(files.length>0){
        const file=files[0];
        const fname=file.name.toLowerCase();
        if(fname.endsWith(".txt")||fname.endsWith(".doc")){
          let reader=new FileReader();
          reader.onload=function(evt){
            editor.innerText=evt.target.result;
            logEvent("File loaded: "+file.name);
          };
          reader.readAsText(file,"UTF-8");
        } else {
          showToast("Only .txt or .doc files are supported.");
        }
      }
    });

    /*******************************************************
     * 9) Ëá™Áî±ËæìÂÖ•Ê®°Âºè - ÈïøÊåâ => Tap
     *******************************************************/
    editor.addEventListener("mousedown",(e)=>{
      if(inputMode.style.display==="none")return;
      tapTriggered=false;
      globalTapIndex=getCaretIndex(e.clientX,e.clientY);
      pressTimer=setTimeout(()=>{
        tapTriggered=true;
        handleTapSayInFreeMode();
      },600);
    });
    editor.addEventListener("mouseup",()=>clearTimeout(pressTimer));
    editor.addEventListener("mouseleave",()=>clearTimeout(pressTimer));
    editor.addEventListener("touchstart",(e)=>{
      if(inputMode.style.display==="none")return;
      tapTriggered=false;
      let t=e.touches[0];
      globalTapIndex=getTouchIndex(t.clientX,t.clientY);
      pressTimer=setTimeout(()=>{
        tapTriggered=true;
        handleTapSayInFreeMode();
      },1000);
    });
    editor.addEventListener("touchend",()=>clearTimeout(pressTimer));
    editor.addEventListener("touchcancel",()=>clearTimeout(pressTimer));

    function handleTapSayInFreeMode(){
      currentMode="tap";
      console.log('[Debug] handleTapSayInFreeMode => globalTapIndex:',globalTapIndex);
      let {sentence,relativeIndex}=getSelectedSentenceAndRelativeIndex(editor.innerText,globalTapIndex);
      console.log('[Debug] sentence chosen:',sentence,'relativeIndex:',relativeIndex);
      sentence=sentence.trim();
      if(!sentence){
        logEvent("No valid sentence found");
        return;
      }
      localTapIndex=relativeIndex;
      touchIndexSpan.innerText=String(localTapIndex);
      errorText.innerText=sentence;
      originalSentence=sentence;
      originalErrorSpan.innerText=sentence;
      undoStack.push(editor.innerHTML);

      removeHighlight();
      if(!highlightSentence(sentence)){
        logEvent("Highlight not found => "+sentence);
      }
      setTimeout(()=>{
        moveCaretToEndOfTarget();
        editor.focus();
      },50);

      startRecording();
      setTimeout(()=>editor.focus(),0);
    }

    function getTouchIndex(x,y){
      let rect=editor.getBoundingClientRect();
      let rx=x-rect.left;
      let total=editor.innerText.length;
      if(!total)return 0;
      let ratio=rx/rect.width;
      ratio=Math.max(0,Math.min(1,ratio));
      return Math.floor(ratio*total);
    }

    /*******************************************************
     * 10) highlight / removeHighlight
     *******************************************************/
    function highlightSentence(sentence){
      lastHighlightedSentence=sentence;
      let html=editor.innerHTML;
      let safe=sentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      let re=new RegExp(safe,"i");
      if(!re.test(html))return false;
      editor.innerHTML=html.replace(re,`<span id="target-sentence" class="highlighted-sentence">$&</span>`);
      return true;
    }
    function removeHighlight(){
      let html=editor.innerHTML;
      html=html.replace(/<span id="target-sentence" class="highlighted-sentence">(.*?)<\/span>/i,"$1");
      editor.innerHTML=html;
      moveCaretToEndOfTarget();
    }

    /*******************************************************
     * 11) Start speech recognition
     *******************************************************/
    function startRecording(){
      if(!("SpeechRecognition" in window)&&!("webkitSpeechRecognition" in window)){
        showToast("Speech recognition not supported in this browser.");
        finalizeTapSay();
        return;
      }
      let SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
      recognition=new SpeechRecognition();
      recognition.continuous=false;
      recognition.interimResults=false;
      recognition.lang="en-US";

      recognition.onstart=()=>{
        isListening=true;
        micStatusSpan.innerText="üü¢ Recording...";
        silenceTimer=setTimeout(()=>{
          if(isListening)recognition.stop();
        },5000);
      };
      recognition.onresult=(e)=>{
        clearTimeout(silenceTimer);
        let txt="";
        for(let i=e.resultIndex;i<e.results.length;i++){
          txt+=e.results[i][0].transcript;
        }
        voiceInputSpan.innerText=txt;
      };
      recognition.onerror=(err)=>{
        micStatusSpan.innerText="‚ùå Recording error";
        if(isListening)recognition.stop();
        logEvent("Speech recognition error => "+err.error);
      };
      recognition.onend=()=>{
        isListening=false;
        micStatusSpan.innerText="üî¥ Stopped";
        finalizeTapSay();
      };
      recognition.start();
    }

    /*******************************************************
     * 12) finalizeTapSay
     *******************************************************/
    function finalizeTapSay(){
      let transcript=voiceInputSpan.innerText.trim();
      if(!transcript){
        showToast("No speech input detected.");
        currentMode=null;
        return;
      }
      undoStack.push(editor.innerHTML);

      let parted=errorText.innerText.trimEnd();
      parted=parted.replace(/([.!?])(\S)/g,"$1 $2");
      let textNoPunc=removePunctuation(transcript).trimEnd();
      let merged=(parted+" <||> "+textNoPunc).trimEnd();
      finalOutputSpan.innerText=merged;
      logEvent("Final output => "+merged);

      if(experienceMode.style.display!=="none"){
        sendToAPI(merged,localTapIndex,true);
      }else{
        sendToAPI(merged,localTapIndex,false);
      }
      currentMode=null;
      voiceInputSpan.innerText="";
      lastHighlightedSentence=errorText.innerText;
      clearTimeout(highlightTimeout);
      highlightTimeout=setTimeout(endTapSay,3000);
    }
    function endTapSay(){
      clearTimeout(highlightTimeout);
      removeHighlight();
    }

    /*******************************************************
     * 13) /correct
     *******************************************************/
    function sendToAPI(mergedStr,loc,isExperienceMode=false){
      logEvent("Sending /correct => merged_string:"+mergedStr+", touch_location:"+loc);
      fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          merged_string:mergedStr,
          touch_location:loc
        })
      }).then(resp=>resp.json()).then(data=>{
        let corrs=data.corrections||[];
        logEvent("API corrections => "+JSON.stringify(corrs));
        applyFirstSuggestionAndShowBox(corrs,isExperienceMode);
      }).catch(err=>{
        logEvent("API call error => "+err);
      });
    }

    /*******************************************************
     * 14) applyFirstSuggestionAndShowBox
     *******************************************************/
    function replaceFirstOccurrence(fullText, oldPart, newPart){
      let safe=oldPart.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      let reg=new RegExp(safe,"i");
      return fullText.replace(reg,newPart);
    }

    function applyFirstSuggestionAndShowBox(corrections,isExperienceMode=false){
      if(!corrections.length)return;
      let candidate=corrections[0].trimEnd();

      if(isExperienceMode){
        const errorSentence=document.getElementById("error-sentence");
        if(!errorSentence)return;

        let entireText=errorSentence.innerText;
        let partialReplaced=replaceFirstOccurrence(entireText,originalSentence,candidate);

        errorSentence.innerText=partialReplaced; 
        errorSentence.classList.remove("highlighted-sentence");

        /* ÂÖ≥ÈîÆ‰øÆÂ§ç: ‰πüÊõ¥Êñ∞ originalSentence */
        originalSentence=candidate;

        if(corrections.length>1){
          let highlightSpan=document.querySelector("#error-sentence .highlighted-sentence");
          let rect=null;
          if(highlightSpan){
            rect=highlightSpan.getBoundingClientRect();
          } else {
            rect=errorSentence.getBoundingClientRect();
          }
          suggestionsBox=createSuggestionBox(rect,corrections,true);
          document.body.appendChild(suggestionsBox);
          clearTimeout(suggestionsTimer);
          suggestionsTimer=setTimeout(()=>{ removeSuggestionsBox(); },3000);
        }
        checkCompletion();
      }else{
        let html=editor.innerHTML;
        let safe=originalSentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        let re=new RegExp(safe,"i");
        if(!re.test(html))return;
        editor.innerHTML=html.replace(re,candidate);
        originalSentence=candidate;

        removeHighlight();
        highlightSentence(candidate);
        setTimeout(()=>{ editor.focus(); },300);

        if(corrections.length>1){
          let ts=document.getElementById("target-sentence");
          if(!ts)return;
          let rect=ts.getBoundingClientRect();
          suggestionsBox=createSuggestionBox(rect,corrections,false);
          document.body.appendChild(suggestionsBox);
          clearTimeout(suggestionsTimer);
          suggestionsTimer=setTimeout(()=>{ removeSuggestionsBox(); },3000);
        }
      }
    }

    function createSuggestionBox(rect,corrections,isExpMode=false){
      let box=document.createElement("div");
      box.className="suggestions-box-floating";
      box.style.left=(rect.left+window.scrollX)+"px";
      box.style.top=(rect.bottom+window.scrollY)+"px";
      box.style.width=rect.width+"px";

      for(let i=1;i<corrections.length;i++){
        let div=document.createElement("div");
        div.innerText=corrections[i];
        div.onclick=(evt)=>{
          evt.preventDefault();
          evt.stopPropagation();
          let cand=corrections[i].trimEnd();

          if(isExpMode){
            let errorSentence=document.getElementById("error-sentence");
            if(!errorSentence)return;
            removeHighlightExp();

            let entireText=errorSentence.innerText;
            let updated=replaceFirstOccurrence(entireText,originalSentence,cand);
            errorSentence.innerText=updated;

            /* ÂêåÊ≠•Êõ¥Êñ∞ originalSentence */
            originalSentence=cand;

            highlightExpSentence(cand);
            checkCompletion();
          }else{
            removeHighlight();
            let html=editor.innerHTML;
            let safe=originalSentence.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
            let re=new RegExp(safe,"i");
            editor.innerHTML=html.replace(re,cand);
            originalSentence=cand;
            highlightSentence(cand);
            setTimeout(()=>{
              moveCaretToEndOfTarget();
              editor.focus();
            },300);
          }
          removeSuggestionsBox();
        };
        box.appendChild(div);
      }
      return box;
    }

    function removeHighlightExp(){
      const errorSentence=document.getElementById("error-sentence");
      if(!errorSentence)return;
      errorSentence.innerHTML=errorSentence.innerHTML.replace(/<span class="highlighted-sentence">(.*?)<\/span>/i,"$1");
    }
    function highlightExpSentence(txt){
      const errorSentence=document.getElementById("error-sentence");
      if(!errorSentence)return;
      let html=errorSentence.innerHTML;
      let safe=txt.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      let re=new RegExp(safe,"i");
      errorSentence.innerHTML=html.replace(re,`<span class="highlighted-sentence">$&</span>`);
    }

    /*******************************************************
     * 15) Undo
     *******************************************************/
    undoButton.addEventListener("click",()=>{
      if(undoStack.length>0){
        let prev=undoStack.pop();
        editor.innerHTML=prev;
        removeHighlight();
        showToast("Undo last change");
      } else {
        showToast("No change to undo!");
      }
      editor.focus();
    });

    /*******************************************************
     * 16) moveCaretToEndOfTarget
     *******************************************************/
    function moveCaretToEndOfTarget(){
      setTimeout(()=>{
        const ts=document.getElementById("target-sentence");
        if(!ts && lastHighlightedSentence){
          let range=document.createRange();
          let sel=window.getSelection();
          let txtNode=editor.firstChild;
          if(txtNode){
            let idx=txtNode.textContent.indexOf(lastHighlightedSentence);
            if(idx!==-1){
              range.setStart(txtNode,idx+lastHighlightedSentence.length);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
            }
          }
        }else if(ts){
          let range=document.createRange();
          let sel=window.getSelection();
          range.setStartAfter(ts);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
          editor.focus();
        }
      },0);
    }

    /*******************************************************
     * 17) Â∑•ÂÖ∑ÂáΩÊï∞
     *******************************************************/
    function getCaretIndex(x,y){
      console.log('[Debug] getCaretIndex:',{x,y});
      let range;
      if(document.caretRangeFromPoint){
        range=document.caretRangeFromPoint(x,y);
        console.log('[Debug] range from caretRangeFromPoint:',range);
      } else if(document.caretPositionFromPoint){
        let pos=document.caretPositionFromPoint(x,y);
        if(!pos){
          console.log('[Debug] No pos from caretPositionFromPoint!');
          return -1;
        }
        range=document.createRange();
        range.setStart(pos.offsetNode,pos.offset);
        range.collapse(true);
        console.log('[Debug] range from caretPositionFromPoint:',range);
      }
      if(!range)return -1;
      let pre=range.cloneRange();
      pre.selectNodeContents(editor);
      pre.setEnd(range.startContainer,range.startOffset);

      let caretIndex=pre.toString().length;
      console.log('[Debug] caretIndex:',caretIndex);
      return caretIndex;
    }

    function removePunctuation(str){
      return str.replace(/[^a-zA-Z0-9'\s]/g,"");
    }
    function removeSuggestionsBox(){
      if(suggestionsBox){
        suggestionsBox.remove();
        suggestionsBox=null;
      }
      if(suggestionsTimer){
        clearTimeout(suggestionsTimer);
        suggestionsTimer=null;
      }
    }

    function getSelectedSentenceAndRelativeIndex(text,pos){
      console.log('[Debug] getSelectedSentenceAndRelativeIndex => pos:',pos);
      const sentences=text.match(/[^.!?]+[.!?]+/g)||[text];
      console.log('[Debug] splitted sentences:',sentences);

      let current=0;
      for(let s of sentences){
        let end=current+s.length;
        console.log('[Debug] checking sentence:',s,'start:',current,'end:',end);
        if(pos>=current&&pos<=end){
          console.log('[Debug] matched =>',s,'relativeIndex =>',pos-current);
          return{sentence:s,relativeIndex:pos-current};
        }
        current=end+1;
      }
      console.log('[Debug] no match, fallback =>',sentences[0]);
      return{sentence:sentences[0],relativeIndex:0};
    }

    /*******************************************************
     * 18) ‰ΩìÈ™åÊ®°Âºè
     *******************************************************/
    function initializeExperienceMode(){
      updateSentencePair(0);
      attachExpListeners();
    }
    function attachExpListeners(){
      const prev=document.getElementById("prev-sentence");
      const next=document.getElementById("next-sentence");
      const skip=document.getElementById("skip-sentence-button");
      const nextPair=document.getElementById("next-pair-button");
      const expUndo=document.getElementById("experience-undo-button");
      const errorSentence=document.getElementById("error-sentence");
      if(!prev||!next||!skip||!nextPair||!expUndo||!errorSentence)return;

      // ‰∏ä‰∏ÄÈ¢ò
      prev.addEventListener("click",()=>{
        if(currentPairIndex>0){
          currentPairIndex--;
          updateSentencePair(currentPairIndex);
        }
      });
      // ‰∏ã‰∏ÄÈ¢ò
      next.addEventListener("click",()=>{
        if(currentPairIndex<sentencePairs.length-1){
          currentPairIndex++;
          updateSentencePair(currentPairIndex);
        }
      });
      // skip
      skip.addEventListener("click",()=>{
        if(currentPairIndex<sentencePairs.length-1){
          currentPairIndex++;
          updateSentencePair(currentPairIndex);
          showToast("Skipped current sentence");
        }else{
          showToast("This is the last sentence");
        }
      });
      // nextPair
      nextPair.addEventListener("click",()=>{
        if(currentPairIndex<sentencePairs.length-1){
          currentPairIndex++;
          updateSentencePair(currentPairIndex);
        }else{
          showToast("Congratulations, you have completed all sentences!");
        }
      });
      expUndo.addEventListener("click",()=>{
        if(errorSentence){
          removeHighlightExp();
          errorSentence.classList.remove("highlighted-sentence");
          errorSentence.innerText=sentencePairs[currentPairIndex].error;
          showToast("Restored error sentence");
          originalSentence=sentencePairs[currentPairIndex].error;
        }
      });

      // ÈïøÊåâ => tap
      let pressTimerExp=null;
      errorSentence.addEventListener("mousedown",(e)=>{
        e.preventDefault();
        const rect=e.target.getBoundingClientRect();
        let clickX=e.clientX-rect.left;
        let text=errorSentence.innerText;
        let textLen=text.length;
        if(textLen>0){
          let ratio=clickX/rect.width;
          ratio=Math.max(0,Math.min(1,ratio));
          localTapIndex=Math.floor(ratio*textLen);
        } else {
          localTapIndex=0;
        }
        console.log('[Debug] localTapIndex (char-based):',localTapIndex);
        pressTimerExp=setTimeout(handleExpLongPress,600);
      });
      errorSentence.addEventListener("mouseup",()=>clearTimeout(pressTimerExp));
      errorSentence.addEventListener("mouseleave",()=>clearTimeout(pressTimerExp));

      errorSentence.addEventListener("touchstart",(e)=>{
        e.preventDefault();
        const rect=e.target.getBoundingClientRect();
        let t=e.touches[0];
        let clickX=t.clientX-rect.left;
        let text=errorSentence.innerText;
        let textLen=text.length;
        if(textLen>0){
          let ratio=clickX/rect.width;
          ratio=Math.max(0,Math.min(1,ratio));
          localTapIndex=Math.floor(ratio*textLen);
        } else {
          localTapIndex=0;
        }
        console.log('[Debug] localTapIndex (char-based, touch):',localTapIndex);
        pressTimerExp=setTimeout(handleExpLongPress,1000);
      });
      errorSentence.addEventListener("touchend",()=>clearTimeout(pressTimerExp));
      errorSentence.addEventListener("touchcancel",()=>clearTimeout(pressTimerExp));
    }

    function handleExpLongPress(){
      const errorSentence=document.getElementById("error-sentence");
      if(!errorSentence)return;
      let text=errorSentence.innerText;

      console.log('[Debug] handleExpLongPress => localTapIndex:',localTapIndex);

      const {sentence,startPos,endPos}=findNearestSentenceExp(text,localTapIndex);
      console.log('[Debug] findNearestSentenceExp =>',{sentence,startPos,endPos});

      if(sentence){
        let relativeIndex=Math.min(localTapIndex-startPos,sentence.length);
        console.log('[Debug] final relativeIndex in sentence =>',relativeIndex);

        originalSentence=sentence.trim();
        errorText.innerText=originalSentence;
        originalErrorSpan.innerText=originalSentence;
        localTapIndex=relativeIndex;

        errorSentence.innerHTML=text.replace(sentence,`<span class="highlighted-sentence">${sentence}</span>`);
        currentMode="tap";
        startRecording();
      }
    }
    function findNearestSentenceExp(text,clickPos){
      const sentences=text.match(/[^.!?]+[.!?]+/g)||[text];
      let curr=0;
      let nearestSent=null;
      let nearestStart=0;
      let nearestEnd=0;
      let minDist=Infinity;
      for(let s of sentences){
        let startPos=curr;
        let endPos=startPos+s.length;
        let mid=(startPos+endPos)/2;
        let dist=Math.abs(clickPos-mid);
        if(clickPos>=startPos&&clickPos<=endPos){
          return{sentence:s,startPos,endPos};
        }
        if(dist<minDist){
          minDist=dist;
          nearestSent=s;
          nearestStart=startPos;
          nearestEnd=endPos;
        }
        curr=endPos+1;
      }
      return{
        sentence:nearestSent||sentences[0],
        startPos:nearestStart,
        endPos:nearestEnd
      };
    }

    function updateSentencePair(index){
      const targetSentence=document.getElementById("target-sentence");
      const errorSentence=document.getElementById("error-sentence");
      const indexSpan=document.getElementById("sentence-index");
      const prev=document.getElementById("prev-sentence");
      const next=document.getElementById("next-sentence");

      const oldTip=document.querySelector('.tip-box');
      if(oldTip)oldTip.remove();

      const container=document.getElementById("experience-mode");
      container.insertBefore(addTipBox(sentencePairs[index].tip),container.firstChild);

      if(targetSentence) targetSentence.textContent=sentencePairs[index].target;
      if(errorSentence){
        errorSentence.textContent=sentencePairs[index].error;
        originalSentence=sentencePairs[index].error;
      }
      if(indexSpan) indexSpan.textContent=(index+1)+"/"+sentencePairs.length;
      if(prev) prev.style.visibility=(index===0)?"hidden":"visible";
      if(next) next.style.visibility=(index===sentencePairs.length-1)?"hidden":"visible";

      const skipBtn=document.getElementById("skip-sentence-button");
      skipBtn.textContent="Follow the instruction";
      skipBtn.style.background="#6c757d";
    }
    function addTipBox(tip){
      const tipBox=document.createElement('div');
      tipBox.className='tip-box';
      tipBox.innerHTML=`
        <div class="tip-content">
          <i class="fas fa-lightbulb"></i>
          ${tip}
        </div>
      `;
      return tipBox;
    }

    function checkCompletion(){
      const targetSentence=document.getElementById("target-sentence");
      const errorSentence=document.getElementById("error-sentence");
      const skipBtn=document.getElementById("skip-sentence-button");
      if(!targetSentence||!errorSentence)return;
      if(errorSentence.textContent.trim()===targetSentence.textContent.trim()){
        showToast("Tap&Say succeeded!");
        let newBtn=skipBtn.cloneNode(false);
        skipBtn.parentNode.replaceChild(newBtn,skipBtn);

        if(currentPairIndex===sentencePairs.length-1){
          newBtn.textContent="Switch to Free-input mode?";
          newBtn.style.background="#28a745";
          newBtn.addEventListener("click",()=>{
            modeInput.click();
            showToast("Switched to Free-input mode");
          });
        }else{
          newBtn.textContent="Next Sentence";
          newBtn.style.background="#007bff";
          newBtn.addEventListener("click",function nextHandler(){
            currentPairIndex++;
            updateSentencePair(currentPairIndex);
            this.textContent="Follow the instruction";
            this.style.background="#6c757d";
            this.removeEventListener("click",nextHandler);
          });
        }
      }
    }

    /*******************************************************
     * 19) Undo
     *******************************************************/
    undoButton.addEventListener("click",()=>{
      if(undoStack.length>0){
        let prev=undoStack.pop();
        editor.innerHTML=prev;
        removeHighlight();
        showToast("Undo last change");
      } else {
        showToast("No change to undo!");
      }
      editor.focus();
    });

    /*******************************************************
     * 20) Ê®°ÂºèÂàáÊç¢
     *******************************************************/
    modeInput.addEventListener("click",()=>{
      inputMode.style.display="block";
      experienceMode.style.display="none";
      modeInput.classList.add("active");
      modeExperience.classList.remove("active");
    });
    modeExperience.addEventListener("click",()=>{
      inputMode.style.display="none";
      experienceMode.style.display="block";
      modeExperience.classList.add("active");
      modeInput.classList.remove("active");
      const errSent=document.getElementById("error-sentence");
      if(errSent){
        originalSentence=errSent.innerText; 
      }
    });
  </script>
</body>
</html>
